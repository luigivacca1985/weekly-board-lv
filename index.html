<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Weekly Board – LV</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    const DEFAULT_COLUMNS = ["MANAGEMENT","HR","MARKETING","VENDITE","AMMINISTRAZIONE","PRODUZIONE","R&D","PERSONALE","DA DELEGARE"];
    const STORAGE_KEY = "weekly_board_simple_v1";

    function getISOWeek(date){ const d=new Date(Date.UTC(date.getFullYear(),date.getMonth(),date.getDate())); const dayNum=d.getUTCDay()||7; d.setUTCDate(d.getUTCDate()+4-dayNum); const yearStart=new Date(Date.UTC(d.getUTCFullYear(),0,1)); const weekNo=Math.ceil((((d.getTime()-yearStart.getTime())/86400000)+1)/7); return {week:weekNo,year:d.getUTCFullYear()}; }
    function startOfISOWeek(year,week){ const simple=new Date(Date.UTC(year,0,1+(week-1)*7)); const dow=simple.getUTCDay(); const ISOweekStart=new Date(simple); const diff=(dow<=4?dow-1:dow-8); ISOweekStart.setUTCDate(simple.getUTCDate()-diff); return ISOweekStart; }
    function weeksInYear(year){ const d=new Date(Date.UTC(year,11,31)); const w=getISOWeek(d).week; return w===1?52:w; }
    function isAfterWeek(a,b){ if(!b) return true; return a.year>b.year||(a.year===b.year&&a.week>b.week); }
    function fmtWeekLabel(y,w){ const s=startOfISOWeek(y,w); const e=new Date(s); e.setUTCDate(s.getUTCDate()+6); const fmt=d=>new Date(d).toLocaleDateString('it-IT',{day:'2-digit',month:'2-digit'}); return `Settimana ${w} • ${fmt(s)} – ${fmt(e)}`; }

    function load(){ try{const raw=localStorage.getItem(STORAGE_KEY); if(raw) return JSON.parse(raw);}catch{} return null; }
    function save(data){ try{localStorage.setItem(STORAGE_KEY,JSON.stringify(data));}catch{} }
    function deepClone(o){ return JSON.parse(JSON.stringify(o)); }

    function ensureWeek(state,year,week){
      if(!state.years[year]) state.years[year]={};
      if(!state.years[year][week]){ state.years[year][week]={}; state.settings.columns.forEach(c=>state.years[year][week][c]=[]); }
      else { state.settings.columns.forEach(c=>{ if(!state.years[year][week][c]) state.years[year][week][c]=[]; }); }
      return state.years[year][week];
    }

    function doRollover(state,targetYear,targetWeek){
      const copy=deepClone(state);
      const years=Object.keys(copy.years).map(n=>parseInt(n,10)).sort((a,b)=>a-b);
      if(years.length===0){ copy.lastRollover={year:targetYear,week:targetWeek}; return copy; }
      for(const y of years){
        const maxW=weeksInYear(y);
        for(let w=1; w<=maxW; w++){
          if(y>targetYear||(y===targetYear&&w>=targetWeek)) break;
          const weekData=copy.years[y]?.[w]; if(!weekData) continue;
          const cols=copy.settings.columns;
          cols.forEach(col=>{
            const list=weekData[col]||[];
            const undone=list.filter(t=>!t.done);
            if(undone.length===0) return;
            let y2=y, w2=w+1; const max2=weeksInYear(y2);
            if(w2>max2){ y2=y+1; w2=1; }
            const tgt=ensureWeek(copy,y2,w2);
            tgt[col].push(...undone);
            weekData[col]=list.filter(t=>t.done);
          });
        }
      }
      copy.lastRollover={year:targetYear,week:targetWeek};
      return copy;
    }

    function pad(n){ return String(n).padStart(2,'0'); }
    function icsDate(date){ const y=date.getUTCFullYear(),m=pad(date.getUTCMonth()+1),d=pad(date.getUTCDate()),hh=pad(date.getUTCHours()),mm=pad(date.getUTCMinutes()),ss=pad(date.getUTCSeconds()); return `${y}${m}${d}T${hh}${mm}${ss}Z`; }
    function escapeICS(t){ return (t||'').replace(/\\/g,'\\\\').replace(/\\n/g,'\\\\n').replace(/,/g,'\\\\,').replace(/;/g,'\\\\;'); }

    function App(){
      const {year:curYear,week:curWeek}=getISOWeek(new Date());
      const [state,setState]=useState(()=>load()??({settings:{columns:[...DEFAULT_COLUMNS]},years:{},lastRollover:null}));
      const [view,setView]=useState({year:curYear,week:curWeek});
      const [settingsOpen,setSettingsOpen]=useState(false);
      useEffect(()=>save(state),[state]);

      useEffect(()=>{ const t=getISOWeek(new Date()); if(isAfterWeek(t,state.lastRollover)){ setState(s=>doRollover(s,t.year,t.week)); } },[]);
      const weekData=useMemo(()=>ensureWeek(state,view.year,view.week),[state,view]);

      function setColumns(cols){ setState(prev=>({...prev,settings:{...prev.settings,columns:cols}})); }
      function addTask(col,text){
        if(!text.trim()) return;
        setState(prev=>{ const copy=deepClone(prev); ensureWeek(copy,view.year,view.week)[col].unshift({id:Math.random().toString(36).slice(2,10),text:text.trim(),note:'',done:false,createdAt:new Date().toISOString()}); return copy; });
      }
      function updateTask(col,id,patch){
        setState(prev=>{ const copy=deepClone(prev); const list=ensureWeek(copy,view.year,view.week)[col]; const idx=list.findIndex(t=>t.id===id); if(idx>=0) list[idx]={...list[idx],...patch}; return copy; });
      }
      function deleteTask(col,id){
        setState(prev=>{ const copy=deepClone(prev); const list=ensureWeek(copy,view.year,view.week)[col]; const idx=list.findIndex(t=>t.id===id); if(idx>=0) list.splice(idx,1); return copy; });
      }

      function prevWeek(){ let {year,week}=view; if(week>1) week--; else { year--; week=weeksInYear(year);} setView({year,week}); }
      function nextWeek(){ let {year,week}=view; const max=weeksInYear(year); if(week<max) week++; else { year++; week=1;} setView({year,week}); }

      function exportICS(){
        const cols=state.settings.columns; const data=ensureWeek(state,view.year,view.week);
        const events=[]; const monday=startOfISOWeek(view.year,view.week); const base=new Date(monday); base.setUTCHours(9,0,0,0);
        let offset=0;
        cols.forEach(col=>{
          (data[col]||[]).forEach(task=>{
            const start=new Date(base.getTime()+offset*30*60*1000);
            const end=new Date(start.getTime()+30*60*1000);
            events.push({ uid:task.id, summary:`[${col}] ${task.text}`+(task.done?' (completata)':''), description:task.note||'', dtstart:icsDate(start), dtend:icsDate(end) });
            offset++;
          });
        });
        const ics=`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//LV-Associati//WeeklyBoard//IT
CALSCALE:GREGORIAN
METHOD:PUBLISH
${events.map(e=>`BEGIN:VEVENT
UID:${e.uid}@lv-associati
SUMMARY:${escapeICS(e.summary)}
DESCRIPTION:${escapeICS(e.description)}
DTSTART:${e.dtstart}
DTEND:${e.dtend}
END:VEVENT`).join('\n')}
END:VCALENDAR`;
        const blob=new Blob([ics],{type:'text/calendar;charset=utf-8;'}); const url=URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url; a.download=`settimana_${view.year}_W${String(view.week).padStart(2,'0')}.ics`; a.click(); URL.revokeObjectURL(url);
      }

      const columns=state.settings.columns;

      return (
        <div className="min-h-screen">
          <header className="sticky top-0 z-10 bg-white/80 backdrop-blur border-b">
            <div className="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
              <div className="shrink-0 w-9 h-9 rounded-2xl bg-slate-900 text-white grid place-content-center font-semibold">LV</div>
              <div className="mr-auto">
                <h1 className="text-lg font-semibold">Weekly Board – semplice</h1>
                <p className="text-xs text-slate-500">Bacheca settimanale a colonne con rollover automatico ed export .ics.</p>
              </div>
              <button className="px-3 py-2 rounded-xl border text-sm" onClick={()=>setState(s=>doRollover(s,getISOWeek(new Date()).year,getISOWeek(new Date()).week))}>Esegui rollover</button>
              <button className="px-3 py-2 rounded-xl border text-sm" onClick={exportICS}>Esporta .ics</button>
              <button className="px-3 py-2 rounded-xl border text-sm" onClick={()=>setSettingsOpen(true)}>Impostazioni</button>
            </div>
          </header>

          <main className="max-w-7xl mx-auto p-4">
            <div className="mb-3 flex items-center gap-2">
              <button className="px-2 py-2 rounded-xl border" onClick={prevWeek}>«</button>
              <span className="inline-flex items-center rounded-full border px-2 py-1 text-sm bg-slate-100 text-slate-700">{fmtWeekLabel(view.year, view.week)}</span>
              <button className="px-2 py-2 rounded-xl border" onClick={nextWeek}>»</button>

              <select className="ml-3 rounded-xl border px-3 py-2 text-sm" value={String(view.year)} onChange={e=>setView(p=>({...p,year:parseInt(e.target.value,10)}))}>
                {Array.from({length:7}).map((_,i)=>{ const y=getISOWeek(new Date()).year-3+i; return <option key={y} value={y}>{y}</option> })}
              </select>
              <select className="rounded-xl border px-3 py-2 text-sm" value={String(view.week)} onChange={e=>setView(p=>({...p,week:parseInt(e.target.value,10)}))}>
                {Array.from({length:weeksInYear(view.year)}).map((_,i)=>{ const w=i+1; return <option key={w} value={w}>W{String(w).padStart(2,'0')}</option> })}
              </select>
            </div>

            <div className="grid md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-7 gap-3">
              {columns.map(col=>(
                <Column key={col} title={col} tasks={weekData[col]}
                        onAdd={t=>addTask(col,t)}
                        onToggle={(id,done)=>updateTask(col,id,{done})}
                        onEdit={(id,patch)=>updateTask(col,id,patch)}
                        onDelete={id=>deleteTask(col,id)} />
              ))}
            </div>
          </main>

          {settingsOpen && (
            <Modal title="Impostazioni" onClose={()=>setSettingsOpen(false)}>
              <div className="space-y-2">
                <label className="text-xs font-medium text-slate-600">Etichette colonne (una per riga)</label>
                <EditableColumns cols={columns} onChange={setColumns} />
              </div>
            </Modal>
          )}
        </div>
      );
    }

    function Column({ title, tasks=[], onAdd, onToggle, onEdit, onDelete }){
      const [text,setText]=useState('');
      return (
        <div className="rounded-2xl border bg-white shadow-sm">
          <div className="p-4 border-b rounded-t-2xl">
            <div className="text-base font-semibold flex items-center justify-between">
              <span>{title}</span>
              <span className="text-xs font-normal text-slate-500">{tasks.length} attività</span>
            </div>
          </div>
          <div className="p-4 space-y-3">
            <form onSubmit={(e)=>{e.preventDefault(); onAdd(text); setText('');}} className="flex gap-2">
              <input className="w-full rounded-xl border px-3 py-2 text-sm" value={text} onChange={e=>setText(e.target.value)} placeholder="Aggiungi attività" />
              <button className="px-3 py-2 rounded-xl border text-sm">Aggiungi</button>
            </form>
            <div className="space-y-2">
              {tasks.map(t=>(
                <TaskItem key={t.id} task={t}
                  onToggle={d=>onToggle(t.id,d)}
                  onEdit={p=>onEdit(t.id,p)}
                  onDelete={()=>onDelete(t.id)} />
              ))}
              {tasks.length===0 && <p className="text-xs text-slate-400">Nessuna attività.</p>}
            </div>
          </div>
        </div>
      );
    }

    function TaskItem({ task, onToggle, onEdit, onDelete }){
      const [open,setOpen]=useState(false);
      return (
        <div className={`rounded-lg border p-2 ${task.done?'bg-emerald-50 border-emerald-200':'bg-white'}`}>
          <div className="flex items-start gap-2">
            <input type="checkbox" className="mt-1" checked={task.done} onChange={e=>onToggle(e.target.checked)} />
            <div className="mr-auto">
              <div className={`text-sm ${task.done?'line-through text-slate-400':''}`}>{task.text}</div>
              {task.note && <div className="text-xs text-slate-500 whitespace-pre-wrap mt-1">{task.note}</div>}
            </div>
            <div className="flex gap-1">
              <button className="px-2 py-1 rounded-lg border text-xs" onClick={()=>setOpen(true)}>Dettagli</button>
              <button className="px-2 py-1 rounded-lg border text-xs" onClick={onDelete}>Elimina</button>
            </div>
          </div>

          {open && (
            <Modal title="Dettagli attività" onClose={()=>setOpen(false)}>
              <div className="space-y-2">
                <label className="text-xs font-medium text-slate-600">Titolo</label>
                <input className="w-full rounded-xl border px-3 py-2 text-sm" value={task.text} onChange={e=>onEdit({text:e.target.value})} />
                <label className="text-xs font-medium text-slate-600">Note</label>
                <textarea rows="5" className="w-full rounded-xl border px-3 py-2 text-sm" value={task.note||''} onChange={e=>onEdit({note:e.target.value})}></textarea>
              </div>
            </Modal>
          )}
        </div>
      );
    }

    function EditableColumns({ cols=[], onChange }){
      const [value,setValue]=useState(cols.join('\n'));
      useEffect(()=>setValue((cols||[]).join('\n')),[cols]);
      function apply(){ const lines=value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); const unique=Array.from(new Set(lines)); onChange(unique); }
      return (
        <div className="space-y-2">
          <textarea rows="8" className="w-full rounded-xl border px-3 py-2 text-sm" value={value} onChange={e=>setValue(e.target.value)}></textarea>
          <div className="flex justify-end"><button className="px-3 py-2 rounded-xl border text-sm" onClick={apply}>Applica</button></div>
        </div>
      );
    }

    function Modal({ title, children, onClose }){
      return (
        <div className="fixed inset-0 z-50 grid place-items-center bg-black/40 p-4" onClick={onClose}>
          <div className="w-full max-w-2xl rounded-2xl bg-white shadow-xl" onClick={e=>e.stopPropagation()}>
            <div className="p-4 border-b rounded-t-2xl"><div className="text-base font-semibold">{title}</div></div>
            <div className="p-4">{children}</div>
            <div className="p-3 border-t flex justify-end">
              <button className="px-3 py-2 rounded-xl border text-sm" onClick={onClose}>Chiudi</button>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
