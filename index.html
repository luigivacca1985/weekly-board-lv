<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Weekly Board – LV</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18 UMD + Babel (per JSX senza build) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // ================== Config & Storage ==================
    const SPECIAL_Q2 = "Q2";
    const DEFAULT_COLUMNS = [SPECIAL_Q2,"MANAGEMENT","HR","MARKETING","VENDITE","AMMINISTRAZIONE","PRODUZIONE","R&D","PERSONALE","DA DELEGARE"];
    const STORAGE_KEY = "weekly_board_v6"; // versione con Q2 + appuntamenti 60'

    const nowISO = () => new Date().toISOString();
    const uid = () => Math.random().toString(36).slice(2,10);

    function load(){ try{ const raw = localStorage.getItem(STORAGE_KEY); if (raw) return JSON.parse(raw);}catch{} return null; }
    function save(data){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }catch{} }

    // ================== Week / Date utils (ISO) ==================
    function getISOWeek(date){
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      const weekNo = Math.ceil((((d.getTime()-yearStart.getTime())/86400000)+1)/7);
      return { week: weekNo, year: d.getUTCFullYear() };
    }
    function startOfISOWeek(year, week){
      const simple = new Date(Date.UTC(year,0,1+(week-1)*7));
      const dow = simple.getUTCDay();
      const ISOweekStart = new Date(simple);
      const diff = (dow <= 4 ? dow - 1 : dow - 8);
      ISOweekStart.setUTCDate(simple.getUTCDate() - diff);
      return ISOweekStart; // UTC midnight
    }
    function weeksInYear(year){
      const d = new Date(Date.UTC(year, 11, 31));
      const w = getISOWeek(d).week;
      return w === 1 ? 52 : w;
    }
    function isAfterWeek(a, b){
      if (!b) return true;
      return a.year > b.year || (a.year === b.year && a.week > b.week);
    }
    function fmtWeekLabel(y,w){
      const s = startOfISOWeek(y,w);
      const e = new Date(s); e.setUTCDate(s.getUTCDate()+6);
      const fmt = d => new Date(d).toLocaleDateString('it-IT',{day:'2-digit',month:'2-digit'});
      return `Settimana ${w} • ${fmt(s)} – ${fmt(e)}`;
    }
    function fmtWeekPeriod(y,w){
      const s = startOfISOWeek(y,w);
      const e = new Date(s); e.setUTCDate(s.getUTCDate()+6);
      const fmt = d => new Date(d).toLocaleDateString('it-IT',{day:'2-digit',month:'2-digit'});
      return `${fmt(s)}–${fmt(e)}`;
    }

    // ================== Calendario helpers ==================
    const CAL_START_HOUR = 8;    // 08:00
    const CAL_END_HOUR   = 20;   // 20:00 (escluso)
    const SLOT_MINUTES   = 30;   // passo 30 minuti
    const SLOTS_PER_HOUR = 60 / SLOT_MINUTES;
    const TOTAL_ROWS = (CAL_END_HOUR - CAL_START_HOUR) * SLOTS_PER_HOUR;
    const TASK_DURATION_MIN = 30;      // i task restano a 30'
    const STUDY_DURATION_MIN = 60;     // appuntamenti studio a 60'

    function dateForCell(year, week, weekdayIndex, slotIndex){
      const start = startOfISOWeek(year, week); // UTC
      const d = new Date(start);
      d.setUTCDate(start.getUTCDate() + weekdayIndex);
      const local = new Date(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate(), CAL_START_HOUR, 0, 0, 0);
      const minutes = slotIndex * SLOT_MINUTES;
      local.setMinutes(local.getMinutes() + minutes);
      const pad = n => String(n).padStart(2,'0');
      const y = local.getFullYear();
      const m = pad(local.getMonth()+1);
      const day = pad(local.getDate());
      const hh = pad(local.getHours());
      const mm = pad(local.getMinutes());
      return `${y}-${m}-${day}T${hh}:${mm}`;
    }
    function cellForDatetime(dtString){
      const dt = new Date(dtString);
      const weekdayIndex = (dt.getDay()+6)%7; // 0=Mon..6=Sun
      const minutesFromStart = (dt.getHours() - CAL_START_HOUR) * 60 + dt.getMinutes();
      const slotIndex = Math.max(0, Math.min(TOTAL_ROWS-1, Math.round(minutesFromStart / SLOT_MINUTES)));
      return { weekdayIndex, slotIndex };
    }
    function addMinutesToLocal(dtString, minutes){
      const d = new Date(dtString);
      const d2 = new Date(d.getTime() + minutes*60000);
      const pad = n => String(n).padStart(2,'0');
      const y = d2.getFullYear(), m = pad(d2.getMonth()+1), day = pad(d2.getDate());
      const hh = pad(d2.getHours()), mm = pad(d2.getMinutes());
      return `${y}-${m}-${day}T${hh}:${mm}`;
    }
    function blockStyleFromDatetime(dtString, durationMin){
      const { slotIndex } = cellForDatetime(dtString);
      const pxPerSlot = 24;
      const slots = Math.max(1, Math.round(durationMin / SLOT_MINUTES));
      const top = slotIndex * pxPerSlot;
      const height = pxPerSlot * slots;
      return { top, height };
    }
    function weekdayLabel(year, week, weekdayIndex){
      const s = startOfISOWeek(year, week);
      const d = new Date(s); d.setUTCDate(s.getUTCDate()+weekdayIndex);
      return d.toLocaleDateString('it-IT', { weekday:'short', day:'2-digit', month:'2-digit' });
    }

    // ================== Data model ==================
    /*
      state = {
        settings: { columns: string[] },
        tasks: { [id]: Task },
        events: { [id]: StudyEvent }, // appuntamenti studio
        lastRollover: {year, week} | null
      }
      Task = {
        id, text, note, column,
        done: boolean,
        createdAt: ISO,
        scheduled?: { year:number, week:number, datetime?: string } // "YYYY-MM-DDTHH:mm" (locale)
        __showNotes?: boolean // UI only (backlog)
      }
      StudyEvent = {
        id, title, note?, datetime: string // "YYYY-MM-DDTHH:mm", durata fissa 60'
      }
    */
    function initialState(){
      return {
        settings: { columns: [...DEFAULT_COLUMNS] },
        tasks: {},
        events: {},
        lastRollover: null
      };
    }
    const deep = (o)=> JSON.parse(JSON.stringify(o));

    // ================== Rollover logic (solo task) ==================
    function doRollover(state, targetYear, targetWeek){
      const copy = deep(state);
      const tasks = Object.values(copy.tasks);
      for (const t of tasks){
        if (t.done) continue;
        if (!t.scheduled) continue;
        const { year, week } = t.scheduled;
        if (year < targetYear || (year === targetYear && week < targetWeek)){
          // non svolta: riproposta settimana successiva, senza orario
          let y = year, w = week + 1;
          const max = weeksInYear(y);
          if (w > max) { y = y + 1; w = 1; }
          t.scheduled.year = y;
          t.scheduled.week = w;
          delete t.scheduled.datetime; // diventa "da fissare" (rosso)
        }
      }
      // Gli appuntamenti studio NON fanno rollover automatico
      copy.lastRollover = { year: targetYear, week: targetWeek };
      return copy;
    }

    // ================== App ==================
    function App(){
      const { year: curYear, week: curWeek } = getISOWeek(new Date());
      const [state, setState] = useState(()=> {
        const loaded = load();
        // garantisce presenza e priorità di Q2 anche su storage vecchi
        if (loaded && loaded.settings && Array.isArray(loaded.settings.columns)) {
          let cols = loaded.settings.columns;
          if (!cols.includes(SPECIAL_Q2)) cols = [SPECIAL_Q2, ...cols];
          else cols = [SPECIAL_Q2, ...cols.filter(c=>c!==SPECIAL_Q2)];
          loaded.settings.columns = cols;
        }
        if (loaded && !loaded.events) loaded.events = {};
        return loaded ?? initialState();
      });
      const [route, setRoute] = useState(()=> (location.hash.replace('#','') || 'attivi'));
      const [view, setView] = useState({ year: curYear, week: curWeek });
      const [calendarFocusId, setCalendarFocusId] = useState(null); // task scelto per calendarizzare
      const [settingsOpen, setSettingsOpen] = useState(false);

      // Persistenza
      useEffect(()=>{ save(state); }, [state]);
      useEffect(()=>{ window.addEventListener('beforeunload', ()=>save(state)); }, []);

      // Routing (hash)
      useEffect(()=>{
        const onHash = ()=> setRoute(location.hash.replace('#','') || 'attivi');
        window.addEventListener('hashchange', onHash);
        return ()=> window.removeEventListener('hashchange', onHash);
      }, []);

      // Rollover automatico
      useEffect(()=>{
        const t = getISOWeek(new Date());
        if (isAfterWeek(t, state.lastRollover)) {
          setState(s => doRollover(s, t.year, t.week));
        }
      }, []);

      // ===== Mutazioni Task =====
      function addBacklog(text, column){
        if (!text.trim()) return;
        setState(prev=>{
          const copy = deep(prev);
          const id = uid();
          copy.tasks[id] = { id, text: text.trim(), note:'', column, done:false, createdAt: nowISO() };
          return copy;
        });
      }
      function updateTask(id, patch){
        setState(prev=>{
          const copy = deep(prev);
          if (copy.tasks[id]) copy.tasks[id] = { ...copy.tasks[id], ...patch };
          return copy;
        });
      }
      function removeTask(id){
        setState(prev=>{
          const copy = deep(prev);
          delete copy.tasks[id];
          return copy;
        });
      }
      function assignToWeek(id, year, week){
        setState(prev=>{
          const copy = deep(prev);
          const t = copy.tasks[id]; if (!t) return copy;
          t.scheduled = { year, week }; // senza datetime => rosso
          return copy;
        });
        location.hash = 'settimana';
      }
      function setCalendarTime(id, datetimeLocalValue){
        setState(prev=>{
          const copy = deep(prev);
          const t = copy.tasks[id]; if (!t) return copy;
          if (!t.scheduled) t.scheduled = { year: view.year, week: view.week };
          t.scheduled.datetime = datetimeLocalValue;
          return copy;
        });
      }
      function markDone(id){
        setState(prev=>{
          const copy = deep(prev);
          if (copy.tasks[id]) copy.tasks[id].done = true;
          return copy;
        });
      }

      // ===== Mutazioni Appuntamenti Studio (60') =====
      function addStudy(title, dt){
        if (!title.trim() || !dt) return;
        setState(prev=>{
          const copy = deep(prev);
          const id = uid();
          copy.events[id] = { id, title: title.trim(), datetime: dt };
          return copy;
        });
      }
      function updateStudy(id, patch){
        setState(prev=>{
          const copy = deep(prev);
          if (copy.events[id]) copy.events[id] = { ...copy.events[id], ...patch };
          return copy;
        });
      }
      function removeStudy(id){
        setState(prev=>{
          const copy = deep(prev);
          delete copy.events[id];
          return copy;
        });
      }

      // Colonne modificabili, Q2 sempre presente e prima
      function applyColumns(newCols) {
        const cols = newCols.map(s => s.trim()).filter(Boolean);
        let unique = Array.from(new Set(cols));
        if (!unique.includes(SPECIAL_Q2)) unique.unshift(SPECIAL_Q2);
        else unique = [SPECIAL_Q2, ...unique.filter(c => c !== SPECIAL_Q2)];

        setState(prev => {
          const copy = deep(prev);
          const prevFirst = copy.settings.columns[0] || unique[0];
          copy.settings.columns = unique;
          // riassegna le attività con colonna non più presente
          const fallback = unique[0] || prevFirst;
          for (const t of Object.values(copy.tasks)) {
            if (!unique.includes(t.column)) t.column = fallback;
          }
          return copy;
        });
      }

      // ===== Selettori =====
      const tasksArray = Object.values(state.tasks);
      // Q2 resta nel backlog anche se programmata (finché non è "Fatto")
      const backlogTasks = tasksArray.filter(t =>
        !t.done && (t.column === SPECIAL_Q2 || !t.scheduled)
      );

      const weekTasks = tasksArray.filter(t => !t.done && t.scheduled && t.scheduled.year === view.year && t.scheduled.week === view.week);
      const weekTasksOrdered = [...weekTasks].sort((a,b)=>{
        const aHas = a.scheduled?.datetime ? 1 : 0;
        const bHas = b.scheduled?.datetime ? 1 : 0;
        if (aHas !== bHas) return aHas - bHas; // senza orario (rossi) prima
        return a.createdAt.localeCompare(b.createdAt);
      });

      // Appuntamenti studio nella settimana di vista (durata fissa 60')
      const studyEvents = Object.values(state.events || {});
      const studyEventsWeek = studyEvents.filter(ev => {
        if (!ev.datetime) return false;
        const { year, week } = getISOWeek(new Date(ev.datetime));
        return year === view.year && week === view.week;
      });

      // UI commons
      function WeekSelectors(){
        return (
          <div className="flex items-center gap-2">
            <button className="px-2 py-2 rounded-xl border" onClick={()=>{
              let {year, week} = view;
              if (week>1) week -= 1; else { year -= 1; week = weeksInYear(year); }
              setView({year,week});
            }}>«</button>
            <span className="inline-flex items-center rounded-full border px-2 py-1 text-sm bg-slate-100 text-slate-700">{fmtWeekLabel(view.year, view.week)}</span>
            <button className="px-2 py-2 rounded-xl border" onClick={()=>{
              let {year, week} = view;
              const max = weeksInYear(year);
              if (week<max) week += 1; else { year += 1; week = 1; }
              setView({year,week});
            }}>»</button>

            <select className="ml-3 rounded-xl border px-3 py-2 text-sm" value={String(view.year)} onChange={e=>setView(p=>({...p, year: parseInt(e.target.value,10)}))}>
              {Array.from({length:7}).map((_,i)=>{
                const y = getISOWeek(new Date()).year - 3 + i;
                return <option key={y} value={y}>{y}</option>
              })}
            </select>
            <select className="rounded-xl border px-3 py-2 text-sm" value={String(view.week)} onChange={e=>setView(p=>({...p, week: parseInt(e.target.value,10)}))}>
              {Array.from({length: weeksInYear(view.year)}).map((_,i)=>{
                const w = i+1; return <option key={w} value={w}>W{String(w).padStart(2,'0')}</option>
              })}
            </select>
          </div>
        );
      }

      // ============ Render ============
      return (
        <div className="min-h-screen">
          {/* Navbar */}
          <header className="sticky top-0 z-10 bg-white/80 backdrop-blur border-b">
            <div className="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
              <div className="shrink-0 w-9 h-9 rounded-2xl bg-slate-900 text-white grid place-content-center font-semibold">LV</div>
              <nav className="mr-auto flex gap-1 text-sm">
                <a href="#attivi" className={`px-3 py-2 rounded-xl border ${route==='attivi'?'bg-slate-900 text-white border-slate-900':''}`}>CICLI ATTIVI</a>
                <a href="#settimana" className={`px-3 py-2 rounded-xl border ${route==='settimana'?'bg-slate-900 text-white border-slate-900':''}`}>SETTIMANA</a>
                <a href="#calendario" className={`px-3 py-2 rounded-xl border ${route==='calendario'?'bg-slate-900 text-white border-slate-900':''}`}>CALENDARIO</a>
              </nav>
              <button className="px-3 py-2 rounded-xl border text-sm" onClick={()=>{
                const t = getISOWeek(new Date());
                setState(s => doRollover(s, t.year, t.week));
              }}>Esegui rollover</button>
              <button className="px-3 py-2 rounded-xl border text-sm" onClick={()=>setSettingsOpen(true)}>Impostazioni</button>
            </div>
          </header>

          {/* Contenuto */}
          <main className="max-w-7xl mx-auto p-4 space-y-6">

            {/* CICLI ATTIVI */}
            {route === 'attivi' && (
              <section className="space-y-4">
                <h2 className="text-lg font-semibold">CICLI ATTIVI (Backlog)</h2>
                <AddBacklogForm columns={state.settings.columns} onAdd={addBacklog} />

                <div className="grid md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
                  {[...state.settings.columns].sort((a,b)=>{
                    if (a === SPECIAL_Q2) return -1;
                    if (b === SPECIAL_Q2) return 1;
                    return a.localeCompare(b);
                  }).map(col=>{
                    const items = backlogTasks.filter(t=>t.column===col);
                    return (
                      <div key={col} className="rounded-2xl border bg-white">
                        <div className="p-3 border-b flex items-center justify-between">
                          <div className="font-medium">{col}</div>
                          <div className="text-xs text-slate-500">{items.length} attività</div>
                        </div>
                        <div className="p-3 space-y-2">
                          {items.length===0 && <p className="text-xs text-slate-400">Nessuna attività.</p>}
                          {items.map(t => (
                            <div key={t.id} className={`rounded-lg border p-2 ${t.column===SPECIAL_Q2 ? 'bg-yellow-50 border-yellow-300' : 'bg-white'}`}>
                              <div className="text-sm">{t.text}</div>
                              {t.note && <div className="text-xs text-slate-500 mt-1 whitespace-pre-wrap">{t.note}</div>}
                              <div className="mt-2 flex items-center gap-2">
                                <AssignWeek onAssign={(y,w)=>assignToWeek(t.id,y,w)} />

                                {/* Bottone Note */}
                                <button
                                  className="px-2 py-1 rounded-lg border text-xs"
                                  onClick={() => updateTask(t.id, { __showNotes: !t.__showNotes })}
                                >
                                  Note
                                </button>

                                <button className="px-2 py-1 rounded-lg border text-xs" onClick={()=>removeTask(t.id)}>Elimina</button>
                              </div>

                              {/* Editor note a comparsa */}
                              {t.__showNotes && (
                                <div className="mt-2">
                                  <textarea
                                    rows="3"
                                    className="w-full rounded-lg border px-2 py-1 text-sm"
                                    value={t.note || ''}
                                    onChange={e=>updateTask(t.id, { note: e.target.value })}
                                    placeholder="Aggiungi note..."
                                  ></textarea>
                                </div>
                              )}
                            </div>
                          ))}
                        </div>
                      </div>
                    )
                  })}
                </div>
              </section>
            )}

            {/* SETTIMANA */}
            {route === 'settimana' && (
              <section className="space-y-4">
                <div className="flex items-center justify-between">
                  <h2 className="text-lg font-semibold">SETTIMANA</h2>
                  <WeekSelectors />
                </div>

                <div className="grid md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-7 gap-3">
                  {state.settings.columns.map(col=>{
                    const items = weekTasksOrdered.filter(t=>t.column===col);
                    return (
                      <div key={col} className="rounded-2xl border bg-white">
                        <div className="p-3 border-b flex items-center justify-between">
                          <div className="font-medium">{col}</div>
                          <div className="text-xs text-slate-500">{items.length} attività</div>
                        </div>
                        <div className="p-3 space-y-2">
                          {items.length===0 && <p className="text-xs text-slate-400">Nessuna attività.</p>}
                          {items.map(t => {
                            const needsTime = !(t.scheduled && t.scheduled.datetime);
                            const isQ2 = t.column === SPECIAL_Q2;
                            return (
                              <div key={t.id} className={`rounded-lg border p-2 ${
                                isQ2 ? 'bg-yellow-50 border-yellow-300'
                                     : (needsTime ? 'bg-red-50 border-red-300' : 'bg-white')
                              }`}>
                                <div className="flex items-start gap-2">
                                  <input type="checkbox" className="mt-1" checked={!!t.done}
                                    onChange={e=> e.target.checked ? markDone(t.id) : updateTask(t.id,{done:false})}
                                    title={t.done?'Segna come non fatto':'Segna come fatto'} />
                                  <div className="mr-auto">
                                    <div className={`text-sm ${t.done?'line-through text-slate-400':''}`}>{t.text}</div>
                                    {isQ2 && <div className="text-[11px] text-amber-700 mt-1">Q2</div>}
                                    {!isQ2 && needsTime && <div className="text-[11px] text-red-700 mt-1">Calendario da fissare</div>}
                                    {t.scheduled?.datetime && <div className="text-xs text-slate-500 mt-1">Orario: {t.scheduled.datetime.replace('T',' ')}</div>}
                                  </div>
                                  <div className="flex gap-1">
                                    <button className="px-2 py-1 rounded-lg border text-xs"
                                      onClick={()=>{ setCalendarFocusId(t.id); location.hash='calendario'; }}>
                                      Calendario
                                    </button>
                                    {!isQ2 && (
                                      <button className="px-2 py-1 rounded-lg border text-xs" onClick={()=>updateTask(t.id,{scheduled:undefined})}>
                                        Rimuovi dalla settimana
                                      </button>
                                    )}
                                  </div>
                                </div>
                              </div>
                            )
                          })}
                        </div>
                      </div>
                    )
                  })}
                </div>
              </section>
            )}

            {/* CALENDARIO */}
            {route === 'calendario' && (
              <section className="space-y-4">
                <div className="flex items-center justify-between">
                  <h2 className="text-lg font-semibold">CALENDARIO</h2>
                  <WeekSelectors />
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-5 gap-4">
                  {/* Colonna sinistra: Attività settimana */}
                  <div className="lg:col-span-2 space-y-4">
                    <div className="rounded-2xl border bg-white">
                      <div className="p-3 border-b">Attività della settimana</div>
                      <div className="p-3 space-y-2">
                        {weekTasksOrdered.length===0 && <p className="text-xs text-slate-400">Nessuna attività in settimana.</p>}
                        {weekTasksOrdered.map(t=>{
                          const selected = calendarFocusId === t.id;
                          const needsTime = !(t.scheduled && t.scheduled.datetime);
                          const isQ2 = t.column === SPECIAL_Q2;
                          return (
                            <div key={t.id}
                                 className={`rounded-lg border p-2 cursor-pointer ${selected ? 'ring-2 ring-slate-900' : ''} ${
                                   isQ2 ? 'bg-yellow-50 border-yellow-300'
                                        : (needsTime?'bg-red-50 border-red-300':'bg-white')
                                 }`}
                                 onClick={()=>setCalendarFocusId(t.id)}>
                              <div className="text-sm">{t.text}</div>
                              {isQ2 && <div className="text-[11px] text-amber-700 mt-1">Q2</div>}
                              {t.scheduled?.datetime
                                ? <div className="text-xs text-slate-500 mt-1">Orario: {t.scheduled.datetime.replace('T',' ')}</div>
                                : (!isQ2 && <div className="text-[11px] text-red-700 mt-1">Calendario da fissare</div>)}
                              <div className="mt-2 flex gap-2">
                                <input type="datetime-local"
                                       className="rounded-lg border px-2 py-1 text-xs"
                                       value={t.scheduled?.datetime || ''}
                                       onChange={e=>setCalendarTime(t.id, e.target.value)} />
                                <button className="px-2 py-1 rounded-lg border text-xs bg-emerald-600 text-white border-emerald-600 hover:bg-emerald-700"
                                        onClick={()=>markDone(t.id)}>Fatto ✓</button>
                              </div>
                            </div>
                          )
                        })}
                      </div>
                    </div>

                    {/* Appuntamenti Studio (60') */}
                    <div className="rounded-2xl border bg-white">
                      <div className="p-3 border-b">Appuntamenti Studio (durata 60')</div>
                      <div className="p-3 space-y-3">
                        <StudyForm onAdd={(title,dt)=>addStudy(title,dt)} />
                        <div className="space-y-2">
                          {studyEventsWeek.length===0 && <p className="text-xs text-slate-400">Nessun appuntamento studio in settimana.</p>}
                          {studyEventsWeek.map(ev=>{
                            const end = addMinutesToLocal(ev.datetime, STUDY_DURATION_MIN);
                            return (
                              <div key={ev.id} className="rounded-lg border p-2" style={{ background:'#F5F3FF', borderColor:'#C4B5FD' }}>
                                <div className="text-sm">Studio: {ev.title}</div>
                                <div className="text-xs text-slate-600 mt-1">
                                  Orario: {ev.datetime.replace('T',' ')} – {end.slice(11)}
                                </div>
                                <div className="mt-2 flex flex-wrap items-center gap-2">
                                  <input type="datetime-local"
                                         className="rounded-lg border px-2 py-1 text-xs"
                                         value={ev.datetime}
                                         onChange={e=>updateStudy(ev.id,{ datetime: e.target.value })} />
                                  <button className="px-2 py-1 rounded-lg border text-xs" onClick={()=>removeStudy(ev.id)}>Elimina</button>
                                </div>
                              </div>
                            )
                          })}
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Calendario settimanale */}
                  <div className="lg:col-span-3 rounded-2xl border bg-white overflow-hidden">
                    <CalendarGrid
                      year={view.year}
                      week={view.week}
                      tasks={weekTasksOrdered}
                      study={studyEventsWeek}
                      selectedId={calendarFocusId}
                      onPickSlot={(weekdayIndex, slotIndex)=>{
                        if (calendarFocusId) {
                          const dt = dateForCell(view.year, view.week, weekdayIndex, slotIndex);
                          setCalendarTime(calendarFocusId, dt);
                        } else {
                          // Se non c'è un'attività selezionata, creiamo un appuntamento studio veloce (60')
                          const title = prompt("Titolo Appuntamento Studio (60'):"); 
                          if (title) {
                            const dt = dateForCell(view.year, view.week, weekdayIndex, slotIndex);
                            addStudy(title, dt);
                          }
                        }
                      }}
                    />
                  </div>
                </div>

                <div className="text-xs text-slate-500">
                  Nota: “Fatto” rimuove l’attività sia da <b>SETTIMANA</b> sia da <b>CICLI ATTIVI</b>.  
                  Se non svolta entro la settimana, la riproporrò nella successiva in <span class="text-red-700">rosso</span> (orario da fissare).  
                  Le attività <b>Q2</b> sono evidenziate in <span class="text-amber-700">giallo</span> e non si possono rimuovere dalla settimana.  
                  Gli <b>Appuntamenti Studio</b> durano sempre <b>60 minuti</b> e compaiono in <span class="text-violet-700">viola</span>.
                </div>
              </section>
            )}
          </main>

          {/* Modale Impostazioni */}
          {settingsOpen && (
            <div className="fixed inset-0 z-50 grid place-items-center bg-black/40 p-4" onClick={()=>setSettingsOpen(false)}>
              <div className="w-full max-w-2xl rounded-2xl bg-white shadow-xl" onClick={(e)=>e.stopPropagation()}>
                <div className="p-4 border-b rounded-t-2xl">
                  <div className="text-base font-semibold">Impostazioni</div>
                </div>
                <div className="p-4 space-y-3">
                  <label className="text-xs font-medium text-slate-600">Etichette colonne (una per riga)</label>
                  <EditableColumns
                    initial={state.settings.columns}
                    onApply={(cols)=>{ applyColumns(cols); setSettingsOpen(false); }}
                  />
                  <p className="text-xs text-slate-500">
                    <b>{SPECIAL_Q2}</b> è obbligatoria e resta sempre in prima posizione.
                    Le attività con colonna eliminata verranno riassegnate alla prima colonna disponibile.
                  </p>
                </div>
                <div className="p-3 border-t flex justify-end">
                  <button className="px-3 py-2 rounded-xl border text-sm" onClick={()=>setSettingsOpen(false)}>Chiudi</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ================== Components ==================
    function AddBacklogForm({ columns, onAdd }){
      const [text, setText] = useState('');
      const [col, setCol] = useState(columns[0] || 'Altro');
      useEffect(()=>{ if (!columns.includes(col) && columns.length) setCol(columns[0]) }, [columns]);
      return (
        <form className="rounded-2xl border bg-white p-3 flex flex-wrap gap-2 items-center"
              onSubmit={e=>{ e.preventDefault(); onAdd(text, col); setText(''); }}>
          <input className="flex-1 min-w-[260px] rounded-xl border px-3 py-2 text-sm" value={text} onChange={e=>setText(e.target.value)} placeholder="Nuova attività" />
          <select className="rounded-xl border px-3 py-2 text-sm" value={col} onChange={e=>setCol(e.target.value)}>
            {columns.map(c => <option key={c} value={c}>{c}</option>)}
          </select>
          <button className="px-3 py-2 rounded-xl border text-sm">Aggiungi</button>
        </form>
      );
    }

    function AssignWeek({ onAssign }){
      const { year: curYear, week: curWeek } = getISOWeek(new Date());
      const [year, setYear] = useState(curYear);
      const [week, setWeek] = useState(curWeek);

      function weekLabel(y,w){ return `W${String(w).padStart(2,'0')} ${fmtWeekPeriod(y,w)}`; }

      return (
        <div className="flex items-center gap-1">
          <select className="rounded-lg border px-2 py-1 text-xs" value={String(year)} onChange={e=>setYear(parseInt(e.target.value,10))}>
            {Array.from({length:7}).map((_,i)=> {
              const y = curYear - 3 + i; return <option key={y} value={y}>{y}</option>
            })}
          </select>
          <select className="rounded-lg border px-2 py-1 text-xs" value={String(week)} onChange={e=>setWeek(parseInt(e.target.value,10))}>
            {Array.from({length: weeksInYear(year)}).map((_,i)=> {
              const w = i+1; return <option key={w} value={w}>{weekLabel(year,w)}</option>
            })}
          </select>
          <button className="px-2 py-1 rounded-lg border text-xs" onClick={()=>onAssign(year, week)}>Assegna</button>
        </div>
      );
    }

    function StudyForm({ onAdd }){
      const [title, setTitle] = useState('');
      const [dt, setDt] = useState('');
      return (
        <form className="flex flex-wrap items-center gap-2"
              onSubmit={e=>{ e.preventDefault(); onAdd(title, dt); setTitle(''); setDt(''); }}>
          <input className="flex-1 min-w-[220px] rounded-lg border px-2 py-1 text-sm"
                 placeholder="Titolo appuntamento studio (60')"
                 value={title}
                 onChange={e=>setTitle(e.target.value)} />
          <input type="datetime-local"
                 className="rounded-lg border px-2 py-1 text-sm"
                 value={dt}
                 onChange={e=>setDt(e.target.value)} />
          <button className="px-3 py-2 rounded-lg border text-sm">Aggiungi</button>
        </form>
      );
    }

    function CalendarGrid({ year, week, tasks, study, selectedId, onPickSlot }){
      const pxPerSlot = 24;
      const hours = Array.from({length: CAL_END_HOUR - CAL_START_HOUR}, (_,i)=> CAL_START_HOUR + i);
      const slots = Array.from({length: TOTAL_ROWS}, (_,i)=> i);

      return (
        <div className="w-full">
          {/* Header giorni */}
          <div className="grid" style={{ gridTemplateColumns: '80px repeat(7, 1fr)' }}>
            <div className="bg-slate-100 border-b h-10 flex items-center justify-center text-xs text-slate-600">Ora</div>
            {Array.from({length:7}, (_,d)=>(
              <div key={d} className="bg-slate-100 border-b h-10 flex items-center justify-center text-sm font-medium">
                {weekdayLabel(year, week, d)}
              </div>
            ))}
          </div>

          {/* Corpo: griglia oraria */}
          <div className="relative">
            <div className="grid" style={{ gridTemplateColumns: '80px repeat(7, 1fr)' }}>
              {/* Colonna orari */}
              <div className="border-r">
                {hours.map(h=>(
                  <div key={h} className="h-12 border-b text-[11px] text-slate-500 flex items-start justify-end pr-2">
                    {String(h).padStart(2,'0')}:00
                  </div>
                ))}
              </div>

              {/* 7 colonne dei giorni */}
              {Array.from({length:7}, (_,day)=>(
                <div key={day} className="relative border-r" style={{ height: pxPerSlot*TOTAL_ROWS }}>
                  {/* slot cliccabili */}
                  {slots.map(slot=>(
                    <div key={slot}
                         className={`border-b border-dashed ${slot%2===0?'bg-white':'bg-slate-50'}`}
                         style={{ height: pxPerSlot }}
                         onClick={()=>onPickSlot(day, slot)}
                         title="Clicca per assegnare l'orario (task selezionato) o creare un appuntamento studio (60')">
                    </div>
                  ))}

                  {/* blocchi attività con orario (30') */}
                  {tasks.filter(t => t.scheduled?.datetime && (cellForDatetime(t.scheduled.datetime).weekdayIndex === day))
                        .map(t=>{
                          const { top, height } = blockStyleFromDatetime(t.scheduled.datetime, TASK_DURATION_MIN);
                          const selected = t.id === selectedId;
                          const isQ2 = t.column === SPECIAL_Q2;
                          return (
                            <div key={t.id}
                                 className={`absolute left-1 right-1 rounded-md border px-2 py-1 text-xs overflow-hidden ${selected?'ring-2 ring-slate-900':''}`}
                                 style={{
                                   top,
                                   height,
                                   background: isQ2 ? '#FEF9C3' : '#DBEAFE',   // giallo-100 : azzurro-100
                                   borderColor: isQ2 ? '#FDE68A' : '#93C5FD'   // giallo-300 : azzurro-300
                                 }}
                                 title={t.text}>
                              <div className="truncate">{t.text}</div>
                              <div className="opacity-70">{t.scheduled.datetime.slice(11)}</div>
                            </div>
                          );
                        })}

                  {/* blocchi appuntamenti studio (60') */}
                  {study.filter(ev => cellForDatetime(ev.datetime).weekdayIndex === day)
                        .map(ev=>{
                          const { top, height } = blockStyleFromDatetime(ev.datetime, STUDY_DURATION_MIN);
                          const end = addMinutesToLocal(ev.datetime, STUDY_DURATION_MIN);
                          return (
                            <div key={ev.id}
                                 className="absolute left-1 right-1 rounded-md border px-2 py-1 text-xs overflow-hidden"
                                 style={{
                                   top,
                                   height,
                                   background: '#F5F3FF',   // violet-100
                                   borderColor: '#C4B5FD'   // violet-300
                                 }}
                                 title={ev.title}>
                              <div className="truncate">Studio: {ev.title}</div>
                              <div className="opacity-70">{ev.datetime.slice(11)}–{end.slice(11)}</div>
                            </div>
                          );
                        })}
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    function EditableColumns({ initial, onApply }) {
      const [value, setValue] = React.useState((initial || []).join('\n'));
      React.useEffect(()=> setValue((initial || []).join('\n')), [initial]);

      function handleApply() {
        const lines = value.split(/\r?\n/);
        onApply(lines);
      }

      return (
        <div className="space-y-2">
          <textarea
            rows="8"
            className="w-full rounded-xl border px-3 py-2 text-sm"
            value={value}
            onChange={e=>setValue(e.target.value)}
            placeholder={'Q2\nMANAGEMENT\nHR\nMARKETING\n...'}
          />
          <div className="flex justify-end gap-2">
            <button className="px-3 py-2 rounded-xl border text-sm" onClick={handleApply}>
              Applica
            </button>
          </div>
        </div>
      );
    }

    // ================== Mount ==================
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
